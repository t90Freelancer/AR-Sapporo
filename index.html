<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            overflow: hidden;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #121212;
            color: white;
            position: fixed;
            width: 100%;
            height: 100%;
        }

        #loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: opacity 0.5s;
        }

        #loader.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #2196F3;
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        #status-text {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            font-size: 16px;
            background: rgba(0, 0, 0, 0.7);
            padding: 8px 16px;
            border-radius: 20px;
            z-index: 10;
        }

        #real-camera-video {
            display: none;
        }

        #qr-canvas {
            display: none;
        }

        .tap-to-play {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 100;
        }

        .tap-to-play.show {
            opacity: 1;
        }
    </style>
</head>

<body>
    <div id="loader">
        <div class="spinner"></div>
        <h2>Đang tải ứng dụng...</h2>
        <p id="loading-text">Khởi tạo hệ thống AR</p>
    </div>

    <a-scene id="ar-scene"
        mindar-image="imageTargetSrc: https://cdn.jsdelivr.net/gh/HaiquangPham14/TestARGame2@main/targets.mind"
        color-space="sRGB" renderer="colorManagement: true, physicallyCorrectLights" vr-mode-ui="enabled: false"
        device-orientation-permission-ui="enabled: false">
        <a-assets id="ar-assets">
            <video id="video" src="https://cdn.jsdelivr.net/gh/HaiquangPham14/TestARGame2@main/Sapporo1.mp4"
                preload="auto" crossorigin="anonymous" webkit-playsinline playsinline loop></video>
        </a-assets>

        <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

        <a-entity id="target" mindar-image-target="targetIndex: 0">
            <a-video id="video-plane" width="1" height="0.5625" position="0 0 0" rotation="0 0 0"
                visible="false"></a-video>
            <a-text id="qr-text" value="Video1" align="center" color="white" width="1" position="0 0.35 0"
                visible="false"></a-text>
            <div class="tap-to-play">Chạm để phát video</div>
        </a-entity>
    </a-scene>

    <video id="real-camera-video" autoplay playsinline class="hidden"></video>
    <canvas id="qr-canvas" class="hidden"></canvas>

    <div id="status-text">Đang quét mã QR...</div>

    <script>
        // === BIẾN TOÀN CỤC ===
        let realCameraStream;
        let qrScannerInterval = null;
        let currentTarget = "Video1";
        let targetFound = false;

        // === MAPPING QR CODE VÀ TÀI NGUYÊN ===
        const targetMap = {
            "Video1": {
                mindFile: "https://cdn.jsdelivr.net/gh/HaiquangPham14/TestARGame2@main/targets.mind",
                videoSrc: "https://cdn.jsdelivr.net/gh/HaiquangPham14/TestARGame2@main/Sapporo1.mp4"
            },
            "Video2": {
                mindFile: "https://cdn.jsdelivr.net/gh/HaiquangPham14/TestARGame2@main/targets2.mind",
                videoSrc: "https://cdn.jsdelivr.net/gh/HaiquangPham14/TestARGame2@main/Sapporo2.mp4"
            },
            "Video3": {
                mindFile: "https://cdn.jsdelivr.net/gh/HaiquangPham14/TestARGame2@main/targets3.mind",
                videoSrc: "https://cdn.jsdelivr.net/gh/HaiquangPham14/TestARGame2@main/Sapporo3.mp4"
            },
            "Video4": {
                mindFile: "https://cdn.jsdelivr.net/gh/HaiquangPham14/TestARGame2@main/targets4.mind",
                videoSrc: "https://cdn.jsdelivr.net/gh/HaiquangPham14/TestARGame2@main/Sapporo4.mp4"
            },
            "Video5": {
                mindFile: "https://cdn.jsdelivr.net/gh/HaiquangPham14/TestARGame2@main/targets5.mind",
                videoSrc: "https://cdn.jsdelivr.net/gh/HaiquangPham14/TestARGame2@main/Sapporo5.mp4"
            },
            "Video6": {
                mindFile: "https://cdn.jsdelivr.net/gh/HaiquangPham14/TestARGame2@main/targets6.mind",
                videoSrc: "https://cdn.jsdelivr.net/gh/HaiquangPham14/TestARGame2@main/Sapporo6.mp4"
            }
        };

        // === KHỞI TẠO CAMERA ===
        async function initializeRealCamera() {
            try {
                const video = document.getElementById("real-camera-video");
                realCameraStream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: "environment",
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                    },
                    audio: false
                });
                video.srcObject = realCameraStream;
                await video.play();
                document.getElementById("loading-text").textContent = "Camera đã sẵn sàng";
                return true;
            } catch (error) {
                console.error("Lỗi khi truy cập camera:", error);
                document.getElementById("loader").innerHTML = `
                    <h2>Lỗi khi khởi tạo camera</h2>
                    <p>${error.message || error}</p>
                    <button onclick="location.reload()">Thử lại</button>
                `;
                return false;
            }
        }

        // === QUÉT QR CODE ===
        function scanQRCode() {
            const video = document.getElementById("real-camera-video");
            const qrCanvas = document.getElementById("qr-canvas");
            const qrCtx = qrCanvas.getContext("2d");
            qrCanvas.width = video.videoWidth;
            qrCanvas.height = video.videoHeight;

            qrCtx.drawImage(video, 0, 0, qrCanvas.width, qrCanvas.height);
            const imageData = qrCtx.getImageData(0, 0, qrCanvas.width, qrCanvas.height);
            const code = jsQR(imageData.data, imageData.width, imageData.height);

            if (code && targetMap[code.data]) {
                if (code.data !== currentTarget) {
                    currentTarget = code.data;
                    updateARScene(code.data);
                    document.getElementById("status-text").textContent = `Đã nhận diện: ${code.data}`;
                }
            } else {
                document.getElementById("status-text").textContent = "Đang quét mã QR...";
            }
        }

        // === CẬP NHẬT SCENE AR ===
        function updateARScene(targetId) {
            const scene = document.getElementById("ar-scene");
            const assets = document.getElementById("ar-assets");
            const videoElement = document.getElementById("video");
            const target = document.getElementById("target");
            const videoPlane = document.getElementById("video-plane");
            const qrText = document.getElementById("qr-text");

            // Cập nhật mind file
            scene.setAttribute("mindar-image", `imageTargetSrc: ${targetMap[targetId].mindFile}`);

            // Cập nhật video
            videoElement.src = targetMap[targetId].videoSrc;
            videoElement.load();
            videoPlane.setAttribute("material", `src: #video`);

            // Cập nhật nội dung text
            qrText.setAttribute("value", targetId);
        }

        // === THIẾT LẬP TARGET VỚI TƯƠNG TÁC CHẠM ===
        function setupARTarget() {
            const target = document.getElementById("target");
            const videoPlane = document.getElementById("video-plane");
            const qrText = document.getElementById("qr-text");
            const videoElement = document.getElementById("video");
            const tapToPlay = target.querySelector('.tap-to-play');

            if (!target || !videoPlane || !videoElement || !tapToPlay || !qrText) return;

            target.addEventListener("targetFound", () => {
                targetFound = true;
                videoPlane.setAttribute("visible", "true");
                qrText.setAttribute("visible", "true");
                tapToPlay.classList.add('show');
                videoElement.play().catch(e => {
                    console.log("Cần tương tác để phát video:", e);
                });
                videoElement.currentTime = 0;
            });

            target.addEventListener("targetLost", () => {
                targetFound = false;
                videoElement.pause();
                videoElement.currentTime = 0;
                videoPlane.setAttribute("visible", "false");
                qrText.setAttribute("visible", "false");
                tapToPlay.classList.remove('show');
            });

            target.addEventListener('click', () => {
                if (targetFound) {
                    if (videoElement.paused) {
                        videoElement.play().catch(e => {
                            console.log("Cần tương tác để phát video:", e);
                        });
                    } else {
                        videoElement.pause();
                    }
                }
            });
        }

        // === KHỞI TẠO ỨNG DỤNG ===
        document.addEventListener("DOMContentLoaded", async () => {
            document.getElementById("loading-text").textContent = "Đang khởi tạo...";
            try {
                const cameraReady = await initializeRealCamera();
                if (!cameraReady) return;

                setupARTarget();

                // Bắt đầu quét QR code
                qrScannerInterval = setInterval(scanQRCode, 1000);

                setTimeout(() => {
                    document.getElementById("loader").classList.add("hidden");
                }, 500);
            } catch (e) {
                console.error("Lỗi khởi tạo:", e);
                document.getElementById("loader").innerHTML = `
                    <h2>Lỗi khi khởi tạo ứng dụng</h2>
                    <p>${e.message || e}</p>
                    <button onclick="location.reload()">Thử lại</button>
                `;
            }
        });
    </script>
</body>

</html>